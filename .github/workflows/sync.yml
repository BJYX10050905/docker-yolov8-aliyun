name: Sync YOLOv8 to Aliyun and GHCR

on:
  workflow_dispatch:

jobs:
  sync-job:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          # 使用你提供的成都个人版镜像仓库地址
          registry: crpi-gub8j4sqs24nam8o.cn-chengdu.personal.cr.aliyuncs.com
          username: hanqingdocker
          # 这里的密码我们会存在 GitHub 的 Secrets 里，安全第一
          password: ${{ secrets.ALIBABA_PASSWORD }}

      - name: Sync and Push
        run: |
          SOURCE_IMAGE="hanqingdocker/yolov8:v1"
          
          # 1. 处理 GitHub 镜像地址
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          GHCR_IMAGE="ghcr.io/$OWNER_LOWER/yolov8:v1"
          
          # 2. 处理 阿里云 镜像地址 (假设你的命名空间是 hanqing-research)
          ALIYUN_IMAGE="crpi-gub8j4sqs24nam8o.cn-chengdu.personal.cr.aliyuncs.com/hanqing-research/yolov8:v1"
          
          echo "正在拉取镜像..."
          docker pull $SOURCE_IMAGE
          
          echo "推送到 GitHub..."
          docker tag $SOURCE_IMAGE $GHCR_IMAGE
          docker push $GHCR_IMAGE
          
          echo "推送到 阿里云成都节点..."
          docker tag $SOURCE_IMAGE $ALIYUN_IMAGE
          docker push $ALIYUN_IMAGE
