name: Sync YOLOv8 to Aliyun and GHCR

on:
  workflow_dispatch: # 手动触发按钮

jobs:
  sync-job:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          # 使用你提供的成都个人版镜像仓库地址
          registry: crpi-gub8j4sqs24nam8o.cn-chengdu.personal.cr.aliyuncs.com
          username: hanqingdocker
          password: ${{ secrets.ALIBABA_PASSWORD }} # 调用你刚才设置的保险箱密码

      - name: Sync and Push
        run: |
          SOURCE_IMAGE="hanqingdocker/yolov8:v1"
          
          # 1. 准备 GitHub 镜像地址
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          GHCR_IMAGE="ghcr.io/$OWNER_LOWER/yolov8:v1"
          
          # 2. 准备 阿里云镜像地址 (假设你的命名空间是 hanqing-research)
          ALIYUN_IMAGE="crpi-gub8j4sqs24nam8o.cn-chengdu.personal.cr.aliyuncs.com/hanqing-docker-aliyu/yolov8-aliyun:v1"
          
          echo "正在从 Docker Hub 下载..."
          docker pull $SOURCE_IMAGE
          
          echo "正在同步到 GitHub (GHCR)..."
          docker tag $SOURCE_IMAGE $GHCR_IMAGE
          docker push $GHCR_IMAGE
          
          echo "正在同步到 阿里云 (成都节点)..."
          docker tag $SOURCE_IMAGE $ALIYUN_IMAGE
          docker push $ALIYUN_IMAGE
          
          echo "全部同步完成！"
